## Using Kafka with Apicurio Registry

Begin by using [session 001](/sessions/001) to deploy a Kafka cluster on Kubernetes.

Next, deploy the Apicurio Registry operator.

```sh
$ envsubst < sessions/005/install/apicurio.yaml | kubectl create -f -
customresourcedefinition.apiextensions.k8s.io/apicurioregistries3.registry.apicur.io created
serviceaccount/apicurio-registry-operator created
clusterrole.rbac.authorization.k8s.io/apicurio-registry-operator-clusterrole created
clusterrolebinding.rbac.authorization.k8s.io/apicurio-registry-operator-clusterrolebinding created
deployment.apps/apicurio-registry-operator-v3.1.6 created
```

Once the operator is ready, deploy a registry instance configured with an in-memory storage system.

```sh
$ kubectl create -f sessions/005/install/registry.yaml
apicurioregistry.registry.apicur.io/my-schema-registry created

$ kubectl get po
NAME                                                 READY   STATUS    RESTARTS   AGE
apicurio-registry-operator-v3.1.6-7c9744db7-8ww5b    1/1     Running   0          4m34s
my-cluster-broker-10                                 1/1     Running   0          5m15s
my-cluster-broker-11                                 1/1     Running   0          5m15s
my-cluster-broker-12                                 1/1     Running   0          5m15s
my-cluster-controller-0                              1/1     Running   0          5m15s
my-cluster-controller-1                              1/1     Running   0          5m15s
my-cluster-controller-2                              1/1     Running   0          5m15s
my-cluster-entity-operator-68ff7c4d4-qdhdk           2/2     Running   0          3m19s
my-schema-registry-app-deployment-7f99c5d469-r5749   1/1     Running   0          2m13s
strimzi-cluster-operator-59d87b7b87-4whnd            1/1     Running   0          7m10s
```

Now export the connection parameters and register the test Avro message schema.

> [!NOTE]
> Besides the REST API, the registry provides a web interface for managing schemas and validation rules.

The artifact `id` naming convention combines the topic name with either "key" or "value", depending on whether the serializer handles message keys or values.
By default, the `globalId` generated by the registry is stored in the message payload and used for schema lookup during consumption.
While different schema `version`s share the same artifact `id`, each has a unique `globalId`.

```sh
$ export BOOTSTRAP_SERVERS=$(kubectl get k my-cluster -o yaml | yq '.status.listeners.[] | select(.name == "plain").bootstrapServers') \
  REGISTRY_URL=http://$(kubectl get apicurioregistries3 my-schema-registry -o jsonpath="{.spec.app.ingress.host}")/apis/registry/v3 \
  TOPIC_NAME="my-topic"

$ curl -s -X POST "$REGISTRY_URL"/groups/default/artifacts \
  -H "Content-Type: application/json" \
  -d @sessions/005/install/my-topic-value.json | yq -j
{
  "artifact": {
    "owner": "",
    "createdOn": "2026-01-20T10:26:49Z",
    "modifiedBy": "",
    "modifiedOn": "2026-01-20T10:26:49Z",
    "artifactType": "AVRO",
    "artifactId": "my-topic-value"
  },
  "version": {
    "version": "1",
    "owner": "",
    "createdOn": "2026-01-20T10:26:49Z",
    "artifactType": "AVRO",
    "globalId": 1,
    "state": "ENABLED",
    "contentId": 1,
    "artifactId": "my-topic-value",
    "modifiedBy": "",
    "modifiedOn": "2026-01-20T10:26:49Z"
  }
}
```

With the schema registered, start the application and observe its output.

```sh
$ envsubst < sessions/005/install/kafka-avro.yaml | kubectl create -f -
deployment.apps/kafka-avro created

$ kubectl logs -f $(kubectl get po -l app=kafka-avro -o name)
08:25:25.624 [main] INFO  it.fvaleri.kafka.Main - Producing records
08:25:25.832 [main] INFO  it.fvaleri.kafka.Main - Consuming records
08:25:29.539 [main] INFO  it.fvaleri.kafka.Main - Record: Hello-1758875125640
08:25:29.540 [main] INFO  it.fvaleri.kafka.Main - Record: Hello-1758875125831
08:25:29.540 [main] INFO  it.fvaleri.kafka.Main - Record: Hello-1758875125832
08:25:29.540 [main] INFO  it.fvaleri.kafka.Main - Record: Hello-1758875125832
08:25:29.540 [main] INFO  it.fvaleri.kafka.Main - Record: Hello-1758875125832
```

Finally, use the REST API to examine schema content, which can be helpful for debugging purposes.

```sh
$ curl -s "$REGISTRY_URL"/groups/default/artifacts/my-topic-value/versions | yq -j
{
  "count": 1,
  "versions": [
    {
      "createdOn": "2026-01-20T10:26:49Z",
      "owner": "",
      "artifactType": "AVRO",
      "state": "ENABLED",
      "globalId": 1,
      "version": "1",
      "contentId": 1,
      "artifactId": "my-topic-value",
      "modifiedBy": "",
      "modifiedOn": "2026-01-20T10:26:49Z"
    }
  ]
}

$ curl -s "$REGISTRY_URL"/groups/default/artifacts/my-topic-value/versions/1/content | yq -j
{
  "type": "record",
  "name": "Greeting",
  "fields": [
    {
      "name": "Message",
      "type": "string"
    },
    {
      "name": "Time",
      "type": "long"
    }
  ]
}
```
